{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.1.42791",
      "templateHash": "17884026051350157285"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "spaincentral",
      "metadata": {
        "description": "Location for the resources"
      }
    },
    "projectCode": {
      "type": "string",
      "defaultValue": "ss",
      "metadata": {
        "description": "Project code"
      }
    },
    "serviceCode": {
      "type": "string",
      "defaultValue": "hub",
      "metadata": {
        "description": "Service code for shared services"
      }
    },
    "costCenter": {
      "type": "string",
      "defaultValue": "1000",
      "metadata": {
        "description": "Cost center for billing"
      }
    },
    "createdBy": {
      "type": "string",
      "defaultValue": "bicep-deployment",
      "metadata": {
        "description": "Created by information"
      }
    },
    "owner": {
      "type": "string",
      "defaultValue": "tiago-nunes",
      "metadata": {
        "description": "Owner"
      }
    },
    "ownerEmail": {
      "type": "string",
      "defaultValue": "tiago.nunes@example.com",
      "metadata": {
        "description": "Owner email"
      }
    },
    "createdDate": {
      "type": "string",
      "defaultValue": "[utcNow('yyyy-MM-dd')]",
      "metadata": {
        "description": "Creation date for tagging"
      }
    },
    "gitHubOrganizationName": {
      "type": "string",
      "metadata": {
        "description": "GitHub organization name to federate with"
      }
    },
    "gitHubRepositoryName": {
      "type": "string",
      "metadata": {
        "description": "GitHub repository name to federate with"
      }
    },
    "workloadIdentities": {
      "type": "object",
      "defaultValue": {
        "creator": {
          "UAMI": "creator",
          "ENV": "shared-protected",
          "ROLE": "contributor",
          "federationTypes": "environment"
        },
        "push": {
          "UAMI": "acr-push",
          "ENV": "shared",
          "ROLE": "AcrPush",
          "federationTypes": "environment"
        }
      },
      "metadata": {
        "description": "GitHub workload identities for the shared resources infrastructure. Each entry defines a UAMI, its environment, RBAC role, and federation types."
      }
    }
  },
  "variables": {
    "standardTags": {
      "environment": "shared",
      "project": "[parameters('projectCode')]",
      "service": "[parameters('serviceCode')]",
      "costCenter": "[parameters('costCenter')]",
      "createdBy": "[parameters('createdBy')]",
      "owner": "[parameters('owner')]",
      "ownerEmail": "[parameters('ownerEmail')]",
      "createdDate": "[parameters('createdDate')]",
      "managedBy": "bicep",
      "deployment": "[deployment().name]"
    },
    "envMapping": {
      "dev": "d",
      "prod": "p",
      "shared": "s"
    },
    "hubRgName": "[format('{0}-{1}-{2}-rg', parameters('projectCode'), variables('envMapping').shared, parameters('serviceCode'))]",
    "mgmtRgName": "[format('{0}-{1}-mgmt-rg', parameters('projectCode'), variables('envMapping').shared)]",
    "ContributorRoleDefinitionId": "[format('/subscriptions/{0}/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c', subscription().subscriptionId)]",
    "AcrPushRoleDefinitionId": "[format('/subscriptions/{0}/providers/Microsoft.Authorization/roleDefinitions/8311e382-0749-4cb8-b61a-304f252e45ec', subscription().subscriptionId)]",
    "roleIdMap": {
      "contributor": "[variables('ContributorRoleDefinitionId')]",
      "AcrPush": "[variables('AcrPushRoleDefinitionId')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('hubRgName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('standardTags')]"
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('mgmtRgName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('standardTags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "standard-tags",
      "resourceGroup": "[variables('mgmtRgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "shared"
          },
          "project": {
            "value": "[parameters('projectCode')]"
          },
          "service": {
            "value": "[parameters('serviceCode')]"
          },
          "costCenter": {
            "value": "[parameters('costCenter')]"
          },
          "createdBy": {
            "value": "[parameters('createdBy')]"
          },
          "owner": {
            "value": "[parameters('owner')]"
          },
          "ownerEmail": {
            "value": "[parameters('ownerEmail')]"
          },
          "createdDate": {
            "value": "[parameters('createdDate')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "7158475074293203830"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "prod",
                "shared"
              ],
              "metadata": {
                "description": "Environment name"
              }
            },
            "project": {
              "type": "string",
              "minLength": 2,
              "maxLength": 3,
              "metadata": {
                "description": "Project code (2-3 lowercase letters)"
              }
            },
            "service": {
              "type": "string",
              "minLength": 2,
              "maxLength": 4,
              "metadata": {
                "description": "Service code (2-4 lowercase letters)"
              }
            },
            "costCenter": {
              "type": "string",
              "minLength": 4,
              "maxLength": 6,
              "metadata": {
                "description": "Cost center (4-6 digits)"
              }
            },
            "createdBy": {
              "type": "string",
              "metadata": {
                "description": "Created by (letters, numbers, spaces, underscore, dash)"
              }
            },
            "owner": {
              "type": "string",
              "metadata": {
                "description": "Owner (lowercase letters, numbers, dash)"
              }
            },
            "ownerEmail": {
              "type": "string",
              "metadata": {
                "description": "Owner email address"
              }
            },
            "additionalTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional tags to merge"
              }
            },
            "deploymentName": {
              "type": "string",
              "defaultValue": "[deployment().name]",
              "metadata": {
                "description": "Optional deployment name for traceability"
              }
            },
            "createdDate": {
              "type": "string",
              "defaultValue": "[utcNow('yyyy-MM-dd')]",
              "metadata": {
                "description": "Creation date for tagging"
              }
            }
          },
          "variables": {
            "standardTags": {
              "environment": "[parameters('environment')]",
              "project": "[parameters('project')]",
              "service": "[parameters('service')]",
              "costCenter": "[parameters('costCenter')]",
              "createdBy": "[parameters('createdBy')]",
              "owner": "[parameters('owner')]",
              "ownerEmail": "[parameters('ownerEmail')]",
              "createdDate": "[parameters('createdDate')]",
              "managedBy": "bicep",
              "deployment": "[parameters('deploymentName')]"
            },
            "allTags": "[union(variables('standardTags'), parameters('additionalTags'))]",
            "isValidProject": "[and(greaterOrEquals(length(parameters('project')), 2), lessOrEquals(length(parameters('project')), 3))]",
            "isValidService": "[and(greaterOrEquals(length(parameters('service')), 2), lessOrEquals(length(parameters('service')), 4))]",
            "isValidCostCenter": "[and(greaterOrEquals(length(parameters('costCenter')), 4), lessOrEquals(length(parameters('costCenter')), 6))]",
            "isValidCreatedBy": "[greater(length(parameters('createdBy')), 0)]",
            "isValidOwner": "[greater(length(parameters('owner')), 0)]",
            "isValidEmail": "[and(contains(parameters('ownerEmail'), '@'), contains(parameters('ownerEmail'), '.'))]",
            "isValid": "[and(and(and(and(and(variables('isValidProject'), variables('isValidService')), variables('isValidCostCenter')), variables('isValidCreatedBy')), variables('isValidOwner')), variables('isValidEmail'))]"
          },
          "resources": [],
          "outputs": {
            "tags": {
              "type": "object",
              "value": "[variables('allTags')]"
            },
            "isValid": {
              "type": "bool",
              "value": "[variables('isValid')]"
            },
            "validation": {
              "type": "object",
              "value": {
                "project": {
                  "value": "[parameters('project')]",
                  "isValid": "[variables('isValidProject')]"
                },
                "service": {
                  "value": "[parameters('service')]",
                  "isValid": "[variables('isValidService')]"
                },
                "costCenter": {
                  "value": "[parameters('costCenter')]",
                  "isValid": "[variables('isValidCostCenter')]"
                },
                "createdBy": {
                  "value": "[parameters('createdBy')]",
                  "isValid": "[variables('isValidCreatedBy')]"
                },
                "owner": {
                  "value": "[parameters('owner')]",
                  "isValid": "[variables('isValidOwner')]"
                },
                "ownerEmail": {
                  "value": "[parameters('ownerEmail')]",
                  "isValid": "[variables('isValidEmail')]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('mgmtRgName'))]"
      ]
    },
    {
      "copy": {
        "name": "uamiNamingModules",
        "count": "[length(items(parameters('workloadIdentities')))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('uami-naming-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)]",
      "resourceGroup": "[variables('mgmtRgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectCode": {
            "value": "[parameters('projectCode')]"
          },
          "environment": {
            "value": "shared"
          },
          "serviceCode": {
            "value": "[items(parameters('workloadIdentities'))[copyIndex()].value.UAMI]"
          },
          "resourceType": {
            "value": "id"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "17848636303774744973"
            }
          },
          "parameters": {
            "projectCode": {
              "type": "string",
              "defaultValue": "ss",
              "minLength": 2,
              "maxLength": 3,
              "metadata": {
                "description": "Project code (2-3 lowercase letters)"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "prod",
                "shared"
              ],
              "metadata": {
                "description": "Environment (dev, prod, shared)"
              }
            },
            "serviceCode": {
              "type": "string",
              "minLength": 2,
              "maxLength": 4,
              "metadata": {
                "description": "Service code (2-4 lowercase letters)"
              }
            },
            "resourceType": {
              "type": "string",
              "allowedValues": [
                "ca",
                "cae",
                "rg",
                "vnet",
                "sub",
                "pe",
                "log",
                "swa",
                "kv",
                "acr",
                "cosmos",
                "id"
              ],
              "metadata": {
                "description": "Resource type code"
              }
            },
            "sequence": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional sequence number (01-99)"
              }
            }
          },
          "variables": {
            "envMapping": {
              "dev": "d",
              "prod": "p",
              "shared": "s"
            },
            "mappedEnv": "[variables('envMapping')[parameters('environment')]]",
            "baseName": "[format('{0}-{1}-{2}-{3}{4}', parameters('projectCode'), variables('mappedEnv'), parameters('serviceCode'), parameters('resourceType'), if(empty(parameters('sequence')), '', parameters('sequence')))]",
            "sanitizedName": "[if(or(equals(parameters('resourceType'), 'kv'), equals(parameters('resourceType'), 'acr')), replace(toLower(variables('baseName')), '-', ''), toLower(variables('baseName')))]",
            "isValidProjectCode": "[and(greaterOrEquals(length(parameters('projectCode')), 2), lessOrEquals(length(parameters('projectCode')), 3))]",
            "isValidServiceCode": "[and(greaterOrEquals(length(parameters('serviceCode')), 2), lessOrEquals(length(parameters('serviceCode')), 4))]",
            "isValidSequence": "[or(empty(parameters('sequence')), and(and(equals(length(parameters('sequence')), 2), greaterOrEquals(int(parameters('sequence')), 1)), lessOrEquals(int(parameters('sequence')), 99)))]"
          },
          "resources": [],
          "outputs": {
            "resourceName": {
              "type": "string",
              "value": "[variables('sanitizedName')]"
            },
            "isValid": {
              "type": "bool",
              "value": "[and(and(variables('isValidProjectCode'), variables('isValidServiceCode')), variables('isValidSequence'))]"
            },
            "components": {
              "type": "object",
              "value": {
                "projectCode": "[parameters('projectCode')]",
                "environment": "[parameters('environment')]",
                "mappedEnvironment": "[variables('mappedEnv')]",
                "serviceCode": "[parameters('serviceCode')]",
                "resourceType": "[parameters('resourceType')]",
                "sequence": "[parameters('sequence')]",
                "baseName": "[variables('baseName')]",
                "sanitizedName": "[variables('sanitizedName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('mgmtRgName'))]"
      ]
    },
    {
      "copy": {
        "name": "uamiModules",
        "count": "[length(items(parameters('workloadIdentities')))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)]",
      "resourceGroup": "[variables('mgmtRgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "uamiLocation": {
            "value": "[parameters('location')]"
          },
          "uamiNames": {
            "value": [
              "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('uami-naming-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)), '2022-09-01').outputs.resourceName.value]"
            ]
          },
          "tags": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', 'standard-tags'), '2022-09-01').outputs.tags.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "5168640857107218154"
            }
          },
          "parameters": {
            "uamiLocation": {
              "type": "string",
              "defaultValue": "spaincentral",
              "metadata": {
                "description": "Location of the User Assigned Managed Identity (UAMI)"
              }
            },
            "uamiNames": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Names of the User Assigned Managed Identity (UAMI) to create"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the User Assigned Managed Identity (UAMI)"
              }
            }
          },
          "resources": [
            {
              "copy": {
                "name": "uami",
                "count": "[length(parameters('uamiNames'))]"
              },
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('uamiNames')[copyIndex()]]",
              "location": "[parameters('uamiLocation')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "uamiIds": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, length(parameters('uamiNames'))))]",
                "input": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiNames')[range(0, length(parameters('uamiNames')))[copyIndex()]])]"
              }
            },
            "uamiClientIds": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, length(parameters('uamiNames'))))]",
                "input": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiNames')[range(0, length(parameters('uamiNames')))[copyIndex()]]), '2023-01-31').clientId]"
              }
            },
            "uamiPrincipalIds": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, length(parameters('uamiNames'))))]",
                "input": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiNames')[range(0, length(parameters('uamiNames')))[copyIndex()]]), '2023-01-31').principalId]"
              }
            },
            "uamiNames": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, length(parameters('uamiNames'))))]",
                "input": "[parameters('uamiNames')[range(0, length(parameters('uamiNames')))[copyIndex()]]]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('mgmtRgName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', 'standard-tags')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('uami-naming-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('uami-naming-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]"
      ]
    },
    {
      "copy": {
        "name": "envFederationModules",
        "count": "[length(items(parameters('workloadIdentities')))]"
      },
      "condition": "[contains(split(items(parameters('workloadIdentities'))[copyIndex()].value.federationTypes, ','), 'environment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('deploy-env-fed-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)]",
      "resourceGroup": "[variables('mgmtRgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "UamiName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)), '2022-09-01').outputs.uamiNames.value[0]]"
          },
          "GitHubOrganizationName": {
            "value": "[parameters('gitHubOrganizationName')]"
          },
          "GitHubRepositoryName": {
            "value": "[parameters('gitHubRepositoryName')]"
          },
          "environmentName": {
            "value": "[items(parameters('workloadIdentities'))[copyIndex()].value.ENV]"
          },
          "fedType": {
            "value": "environment"
          },
          "federatedCredentialName": {
            "value": "[format('gh-env-{0}-{1}', items(parameters('workloadIdentities'))[copyIndex()].value.ENV, items(parameters('workloadIdentities'))[copyIndex()].key)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "4773535637748705082"
            }
          },
          "parameters": {
            "UamiName": {
              "type": "string",
              "metadata": {
                "description": "Name of the existing UAMI to federate with GitHub Actions"
              }
            },
            "GitHubOrganizationName": {
              "type": "string",
              "metadata": {
                "description": "Name of the GitHub organization to federate with"
              }
            },
            "GitHubRepositoryName": {
              "type": "string",
              "metadata": {
                "description": "Name of the GitHub repository to federate with"
              }
            },
            "branchName": {
              "type": "string",
              "defaultValue": "main",
              "metadata": {
                "description": "GitHub branch name (e.g., main)"
              }
            },
            "environmentName": {
              "type": "string",
              "defaultValue": "production",
              "metadata": {
                "description": "GitHub environment to federate with"
              }
            },
            "federatedCredentialName": {
              "type": "string",
              "defaultValue": "github-federation",
              "metadata": {
                "description": "Name for the federated identity credential"
              }
            },
            "fedType": {
              "type": "string",
              "defaultValue": "branch",
              "allowedValues": [
                "environment",
                "branch"
              ],
              "metadata": {
                "description": "Type of federated identity credential. Can be \"environment\" or \"branch\"."
              }
            }
          },
          "variables": {
            "subjectFilter": "[if(equals(parameters('fedType'), 'environment'), format('environment:{0}', parameters('environmentName')), format('ref:refs/heads/{0}', parameters('branchName')))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials",
              "apiVersion": "2023-07-31-preview",
              "name": "[format('{0}/{1}', parameters('UamiName'), parameters('federatedCredentialName'))]",
              "properties": {
                "issuer": "https://token.actions.githubusercontent.com",
                "audiences": [
                  "api://AzureADTokenExchange"
                ],
                "subject": "[format('repo:{0}/{1}:{2}', parameters('GitHubOrganizationName'), parameters('GitHubRepositoryName'), variables('subjectFilter'))]"
              }
            }
          ],
          "outputs": {
            "federatedCredentialId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials', parameters('UamiName'), parameters('federatedCredentialName'))]"
            },
            "federatedCredentialName": {
              "type": "string",
              "value": "[parameters('federatedCredentialName')]"
            },
            "uamiClientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UamiName')), '2023-01-31').clientId]"
            },
            "uamiPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UamiName')), '2023-01-31').principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('mgmtRgName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]"
      ]
    },
    {
      "copy": {
        "name": "branchFederationModules",
        "count": "[length(items(parameters('workloadIdentities')))]"
      },
      "condition": "[contains(split(items(parameters('workloadIdentities'))[copyIndex()].value.federationTypes, ','), 'branch')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('deploy-branch-fed-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)]",
      "resourceGroup": "[variables('mgmtRgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "UamiName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)), '2022-09-01').outputs.uamiNames.value[0]]"
          },
          "GitHubOrganizationName": {
            "value": "[parameters('gitHubOrganizationName')]"
          },
          "GitHubRepositoryName": {
            "value": "[parameters('gitHubRepositoryName')]"
          },
          "branchName": {
            "value": "main"
          },
          "fedType": {
            "value": "branch"
          },
          "federatedCredentialName": {
            "value": "[format('gh-branch-main-{0}', items(parameters('workloadIdentities'))[copyIndex()].value.UAMI)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "4773535637748705082"
            }
          },
          "parameters": {
            "UamiName": {
              "type": "string",
              "metadata": {
                "description": "Name of the existing UAMI to federate with GitHub Actions"
              }
            },
            "GitHubOrganizationName": {
              "type": "string",
              "metadata": {
                "description": "Name of the GitHub organization to federate with"
              }
            },
            "GitHubRepositoryName": {
              "type": "string",
              "metadata": {
                "description": "Name of the GitHub repository to federate with"
              }
            },
            "branchName": {
              "type": "string",
              "defaultValue": "main",
              "metadata": {
                "description": "GitHub branch name (e.g., main)"
              }
            },
            "environmentName": {
              "type": "string",
              "defaultValue": "production",
              "metadata": {
                "description": "GitHub environment to federate with"
              }
            },
            "federatedCredentialName": {
              "type": "string",
              "defaultValue": "github-federation",
              "metadata": {
                "description": "Name for the federated identity credential"
              }
            },
            "fedType": {
              "type": "string",
              "defaultValue": "branch",
              "allowedValues": [
                "environment",
                "branch"
              ],
              "metadata": {
                "description": "Type of federated identity credential. Can be \"environment\" or \"branch\"."
              }
            }
          },
          "variables": {
            "subjectFilter": "[if(equals(parameters('fedType'), 'environment'), format('environment:{0}', parameters('environmentName')), format('ref:refs/heads/{0}', parameters('branchName')))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials",
              "apiVersion": "2023-07-31-preview",
              "name": "[format('{0}/{1}', parameters('UamiName'), parameters('federatedCredentialName'))]",
              "properties": {
                "issuer": "https://token.actions.githubusercontent.com",
                "audiences": [
                  "api://AzureADTokenExchange"
                ],
                "subject": "[format('repo:{0}/{1}:{2}', parameters('GitHubOrganizationName'), parameters('GitHubRepositoryName'), variables('subjectFilter'))]"
              }
            }
          ],
          "outputs": {
            "federatedCredentialId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials', parameters('UamiName'), parameters('federatedCredentialName'))]"
            },
            "federatedCredentialName": {
              "type": "string",
              "value": "[parameters('federatedCredentialName')]"
            },
            "uamiClientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UamiName')), '2023-01-31').clientId]"
            },
            "uamiPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UamiName')), '2023-01-31').principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-env-fed-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('mgmtRgName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]"
      ]
    },
    {
      "copy": {
        "name": "rbacAssignments",
        "count": "[length(items(parameters('workloadIdentities')))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('deploy-rbac-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)]",
      "resourceGroup": "[variables('hubRgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "uamiPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)), '2022-09-01').outputs.uamiPrincipalIds.value[0]]"
          },
          "roleDefinitionId": {
            "value": "[variables('roleIdMap')[items(parameters('workloadIdentities'))[copyIndex()].value.ROLE]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.36.1.42791",
              "templateHash": "12806316129951810008"
            }
          },
          "parameters": {
            "uamiPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the User-Assigned Managed Identity"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Role definition ID to assign (full resource path)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('uamiPrincipalId'), parameters('roleDefinitionId'), resourceGroup().id)]",
              "properties": {
                "principalId": "[parameters('uamiPrincipalId')]",
                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', guid(parameters('uamiPrincipalId'), parameters('roleDefinitionId'), resourceGroup().id))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('hubRgName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key))]"
      ]
    }
  ],
  "outputs": {
    "uamiNames": {
      "type": "array",
      "copy": {
        "count": "[length(items(parameters('workloadIdentities')))]",
        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)), '2022-09-01').outputs.uamiNames.value[0]]"
      }
    },
    "uamiPrincipalIds": {
      "type": "array",
      "copy": {
        "count": "[length(items(parameters('workloadIdentities')))]",
        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-uami-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)), '2022-09-01').outputs.uamiPrincipalIds.value[0]]"
      }
    },
    "federatedCredentialNames": {
      "type": "array",
      "copy": {
        "count": "[length(items(parameters('workloadIdentities')))]",
        "input": {
          "env": "[if(contains(split(items(parameters('workloadIdentities'))[copyIndex()].value.federationTypes, ','), 'environment'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-env-fed-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)), '2022-09-01').outputs.federatedCredentialName.value, null())]",
          "branch": "[if(contains(split(items(parameters('workloadIdentities'))[copyIndex()].value.federationTypes, ','), 'branch'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('mgmtRgName')), 'Microsoft.Resources/deployments', format('deploy-branch-fed-{0}', items(parameters('workloadIdentities'))[copyIndex()].key)), '2022-09-01').outputs.federatedCredentialName.value, null())]"
        }
      }
    },
    "managementResourceGroupName": {
      "type": "string",
      "value": "[variables('mgmtRgName')]"
    },
    "artifactsResourceGroupName": {
      "type": "string",
      "value": "[variables('hubRgName')]"
    }
  }
}