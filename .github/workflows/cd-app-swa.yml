name: 'CD - Deploy Static Content to SWA'

on:
  push:
    branches: [development, main]
    paths:
      # --- TRIGGER on changes to frontend static files ---
      - 'src/frontend/static/**'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod

permissions:
  actions: write
  contents: read
  id-token: write

jobs:
  determine-environment:
    name: 'Determine Environment'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: 'Set Environment'
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  deploy-swa:
    name: 'Deploy to Static Web App'
    runs-on: ubuntu-latest
    needs: [determine-environment]
    environment: ${{ needs.determine-environment.outputs.environment }}-swa
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 'Login to Azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.CLIENTID_ARTIFACT_PUSH }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      - name: 'Set Environment Variables'
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          
          # Use environment-specific variable for Static Web App name for flexibility
          # These should be configured as repository variables: SWA_NAME
          SWA_NAME="${{ vars.SWA_NAME }}"
          echo "SWA_NAME=$SWA_NAME" >> $GITHUB_ENV
          
          # Use environment-specific variable for resource group name for flexibility
          # These should be configured as repository variables: RG_NAME
          RG_NAME="${{ vars.RG_NAME }}"
          echo "RG_NAME=$RG_NAME" >> $GITHUB_ENV
      
      - name: 'Setup Node.js for SWA CLI'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: 'Install Static Web Apps CLI'
        run: |
          npm install -g @azure/static-web-apps-cli
      
      - name: 'Deploy to Static Web App'
        run: |
          echo "üöÄ Deploying to Static Web App: $SWA_NAME in resource group: $RG_NAME"
          
          # Deploy using SWA CLI with Azure credentials
          swa deploy ./src/frontend/static \
            --resource-group "$RG_NAME" \
            --app-name "$SWA_NAME" \
            --env production \
            --verbose
          
          echo "‚úÖ Deployment completed successfully!"
      
      - name: 'Verify Deployment'
        run: |
          echo "üîç Verifying Static Web App deployment..."
          
          # Get the Static Web App URL
          SWA_URL=$(az staticwebapp show \
            --name "$SWA_NAME" \
            --resource-group "$RG_NAME" \
            --query "defaultHostname" \
            --output tsv)
          
          if [ -n "$SWA_URL" ] && [ "$SWA_URL" != "null" ]; then
            echo "‚úÖ Static Web App deployed successfully!"
            echo "üåê URL: https://$SWA_URL"
            echo "SWA_URL=https://$SWA_URL" >> $GITHUB_ENV
          else
            echo "‚ùå Failed to get Static Web App URL"
            exit 1
          fi
      
      - name: 'Health Check'
        run: |
          echo "üîç Performing health check on deployed application..."
          
          # Wait a bit for deployment to propagate
          sleep 30
          
          # Perform basic health check
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SWA_URL" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Health check passed - Application is responding"
          else
            echo "‚ö†Ô∏è Health check returned status: $HTTP_STATUS"
            echo "‚ÑπÔ∏è This might be expected for initial deployments or if the app requires specific paths"
          fi
          
          echo "üéâ Deployment completed successfully!"
          echo "üìç Environment: $ENVIRONMENT"
          echo "üåê Static Web App URL: $SWA_URL"