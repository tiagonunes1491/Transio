name: 'CI - Infrastructure PR Validation'

on:
  pull_request:
    paths:
      - 'infra/**.bicep'
      - 'infra/**.bicepparam'

permissions:
  id-token: write
  contents: read
  security-events: write
  pull-requests: write

jobs:
  check_changes:
    name: 'Check for file changes'
    runs-on: ubuntu-latest
    outputs:
      bicep_required: ${{ steps.changed-files.outputs.any_changed }}
      changed_files: ${{ steps.changed-files.outputs.all_changed_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for changed-files to work properly
      
      - name: 'Find changed Bicep files'
        id: changed-files
        uses: tj-actions/changed-files@v46 
        with:
          files: |
            infra/**/*.bicep
            infra/**/*.bicepparam

  validate-bicep:
    needs: check_changes
    name: 'Validate Changed Bicep Files'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Setup Azure CLI and Bicep'
        if: needs.check_changes.outputs.bicep_required == 'true'
        shell: bash
        run: |
          echo "ğŸ”§ Setting up Azure CLI and Bicep..."
          
          # Use alternative config directory that doesn't require permissions
          export AZURE_CONFIG_DIR="${RUNNER_TEMP}/.azure"
          mkdir -p "${AZURE_CONFIG_DIR}"
          
          # Set Azure CLI environment variables to prevent permission issues
          export AZURE_CORE_COLLECT_TELEMETRY=false
          export AZURE_CORE_DISABLE_CONFIRM_PROMPT=true
          export AZURE_CORE_DISABLE_PROGRESS_BAR=true
          export AZURE_CORE_ONLY_SHOW_ERRORS=true
          export AZURE_CORE_NO_COLOR=true
          
          # Install Azure CLI (it's pre-installed on GitHub runners)
          echo "ğŸ“¦ Installing Bicep CLI..."
          az bicep install
          
          echo "ğŸ” Verifying Bicep installation..."
          az bicep version
          
          echo "âœ… Bicep CLI setup complete"
        env:
          AZURE_CORE_COLLECT_TELEMETRY: false
          AZURE_CORE_DISABLE_CONFIRM_PROMPT: true
          AZURE_CORE_DISABLE_PROGRESS_BAR: true
          AZURE_CORE_ONLY_SHOW_ERRORS: true
          AZURE_CORE_NO_COLOR: true

      - name: 'Validate Changed Bicep Files'
        if: needs.check_changes.outputs.bicep_required == 'true'
        shell: bash
        env:
          # Use custom Azure config directory
          AZURE_CONFIG_DIR: ${{ runner.temp }}/.azure
          # Prevent Azure CLI permission issues
          AZURE_CORE_COLLECT_TELEMETRY: false
          AZURE_CORE_DISABLE_CONFIRM_PROMPT: true
          AZURE_CORE_DISABLE_PROGRESS_BAR: true
          AZURE_CORE_ONLY_SHOW_ERRORS: true
          AZURE_CORE_NO_COLOR: true
        run: |
          echo "ğŸ” Found changed files: ${{ needs.check_changes.outputs.changed_files }}"

          # Ensure custom Azure config directory exists
          mkdir -p "${AZURE_CONFIG_DIR}"
          
          # Convert space-separated files to array
          IFS=' ' read -ra files <<< "${{ needs.check_changes.outputs.changed_files }}"

          failed_files=()
          
          # Initialize SARIF structure with enhanced metadata
          sarif_file="bicep-validation-results.sarif"
          cat > "$sarif_file" << 'EOF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Bicep Validator",
                    "version": "1.0.0",
                    "informationUri": "https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/",
                    "rules": [
                      {
                        "id": "bicep-build-error",
                        "name": "BicepBuildError",
                        "shortDescription": {
                          "text": "Bicep compilation failed"
                        },
                        "helpUri": "https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-cli#build"
                      },
                      {
                        "id": "bicep-lint",
                        "name": "BicepLintIssue", 
                        "shortDescription": {
                          "text": "Bicep linting issue"
                        },
                        "helpUri": "https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/linter"
                      },
                      {
                        "id": "bicep-param-validation",
                        "name": "BicepParameterValidation",
                        "shortDescription": {
                          "text": "Bicep parameter validation failed"
                        },
                        "helpUri": "https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/parameter-files"
                      }
                    ]
                  }
                },
                "results": [
          EOF

          result_count=0

          for file in "${files[@]}"; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”¨ Processing: $file"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [[ "$file" == *.bicep ]]; then
              # Build Bicep file for syntax validation
              echo "ğŸ“¦ Building Bicep file..."
              build_output=$(mktemp)
              
              if az bicep build --file "$file" --outfile "temp-$(basename "$file" .bicep).json" 2> "$build_output"; then
                echo "âœ… Build successful: $file"
                rm -f "temp-$(basename "$file" .bicep).json"
              else
                echo "âŒ Build failed: $file"
                failed_files+=("$file")
                
                # Extract actual error message from build output
                error_message=$(head -n 1 "$build_output" | sed 's/"/\\"/g')
                if [[ -z "$error_message" ]]; then
                  error_message="Bicep build failed - check syntax and references"
                fi
                
                # Add build failure to SARIF with actual error details
                if [ $result_count -gt 0 ]; then
                  echo "," >> "$sarif_file"
                fi
                cat >> "$sarif_file" << EOF
                  {
                    "ruleId": "bicep-build-error",
                    "level": "error",
                    "message": {
                      "text": "$error_message"
                    },
                    "locations": [
                      {
                        "physicalLocation": {
                          "artifactLocation": {
                            "uri": "$file"
                          }
                        }
                      }
                    ]
                  }
          EOF
                result_count=$((result_count + 1))
                rm -f "$build_output"
                continue
              fi
              rm -f "$build_output"
              
              # Use az bicep lint with SARIF output for better accuracy
              echo "ğŸ” Linting Bicep file..."
              temp_lint_sarif="temp-lint-$(basename "$file" .bicep).sarif"
              
              # Generate SARIF directly from bicep lint
              if az bicep lint --file "$file" --diagnostics-format sarif > "$temp_lint_sarif" 2>/dev/null; then
                echo "âœ… Lint successful: $file"
              else
                echo "âš ï¸ Lint found issues in: $file"
              fi
              
              # Merge lint SARIF results if they exist and have content
              if [[ -f "$temp_lint_sarif" && -s "$temp_lint_sarif" ]]; then
                # Extract results from the temporary SARIF and add to main SARIF
                if command -v jq >/dev/null 2>&1; then
                  while IFS= read -r result; do
                    if [[ -n "$result" && "$result" != "null" ]]; then
                      if [ $result_count -gt 0 ]; then
                        echo "," >> "$sarif_file"
                      fi
                      echo "$result" >> "$sarif_file"
                      result_count=$((result_count + 1))
                    fi
                  done <<< "$(jq -c '.runs[0].results[]?' "$temp_lint_sarif" 2>/dev/null)"
                fi
                rm -f "$temp_lint_sarif"
              fi
              
            elif [[ "$file" == *.bicepparam ]]; then
              # Validate parameter files with SARIF output
              echo "ğŸ“‹ Validating Bicep parameters..."
              temp_param_sarif="temp-param-$(basename "$file" .bicepparam).sarif"
              
              if az bicep lint --file "$file" --diagnostics-format sarif > "$temp_param_sarif" 2>/dev/null; then
                echo "âœ… Parameter validation successful: $file"
              else
                echo "âŒ Parameter validation failed: $file"
                failed_files+=("$file")
              fi
              
              # Merge parameter SARIF results
              if [[ -f "$temp_param_sarif" && -s "$temp_param_sarif" ]]; then
                if command -v jq >/dev/null 2>&1; then
                  while IFS= read -r result; do
                    if [[ -n "$result" && "$result" != "null" ]]; then
                      if [ $result_count -gt 0 ]; then
                        echo "," >> "$sarif_file"
                      fi
                      echo "$result" >> "$sarif_file"
                      result_count=$((result_count + 1))
                    fi
                  done <<< "$(jq -c '.runs[0].results[]?' "$temp_param_sarif" 2>/dev/null)"
                fi
                rm -f "$temp_param_sarif"
              fi
            fi
            
            echo ""
          done

          # Close SARIF file
          cat >> "$sarif_file" << 'EOF'
                ]
              }
            ]
          }
          EOF

          # Validate SARIF file
          if command -v jq >/dev/null 2>&1; then
            if jq empty "$sarif_file" 2>/dev/null; then
              echo "âœ… Valid SARIF file generated"
            else
              echo "âš ï¸ SARIF file may have formatting issues"
            fi
          fi

          # Summary
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š VALIDATION SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total files processed: ${#files[@]}"
          echo "Failed files: ${#failed_files[@]}"
          echo "SARIF results: $result_count"
          echo "ğŸ“„ SARIF file created: $sarif_file"

          if [ ${#failed_files[@]} -gt 0 ]; then
            echo "âŒ The following files failed CRITICAL validation:"
            for failed_file in "${failed_files[@]}"; do
              echo "  - $failed_file"
            done
            echo "ğŸš¨ CI will fail due to critical validation errors"
            exit 1
          else
            echo "âœ… All Bicep files passed validation!"
            echo "ğŸ’¡ Check Security tab for any lint recommendations"
          fi

      - name: 'No Bicep Changes - Validation Skipped'
        if: needs.check_changes.outputs.bicep_required != 'true'
        run: |
          echo "â„¹ï¸ No Bicep files changed - validation skipped"
          echo "If you expected validation to run, check that changes are in infra/ directory with .bicep or .bicepparam extensions"

      - name: 'Upload Bicep Lint SARIF'
        if: always() && needs.check_changes.outputs.bicep_required == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          category: bicep-lint-analysis
          sarif_file: bicep-validation-results.sarif

  post-comment:
    name: 'Post Validation Results Comment'
    needs: [check_changes, validate-bicep]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: 'Post Success Comment'
        if: needs.check_changes.outputs.bicep_required == 'true' && needs.validate-bicep.result == 'success'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… **Bicep Validation Successful**

            All Bicep files passed validation successfully! ğŸ‰

            **Validation Results:**
            - ğŸ“¦ Bicep compilation: âœ… Passed

            **What was validated:**
            - ğŸ“¦ Bicep compilation (syntax validation)
            - ğŸ” Bicep linting (best practices)

            Great work! Your infrastructure code looks good.
          edit-mode: replace

      - name: 'Post Failure Comment'
        if: needs.check_changes.outputs.bicep_required == 'true' && needs.validate-bicep.result != 'success'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âŒ **Bicep Validation Failed**

            One or more Bicep files failed validation.
            Please review the [Checks tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            **Validation Results:**
            - ğŸ“¦ Bicep compilation: ${{ needs.validate-bicep.result == 'success' && 'âœ… Passed' || needs.validate-bicep.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }}

            **What was checked:**
            - ğŸ“¦ Bicep compilation (syntax validation)
            - ğŸ” Bicep linting (best practices)

            Please fix the issues and push your changes.
          edit-mode: replace